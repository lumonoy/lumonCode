<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>59.0</apiVersion>
    <assignments>
        <name>Assign_Case_record_details</name>
        <label>Assign Case record details</label>
        <locationX>786</locationX>
        <locationY>849</locationY>
        <assignmentItems>
            <assignToReference>recCase.Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Case.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>What_is_the_Case_Status</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Change_ownership</name>
        <label>Change ownership</label>
        <locationX>666</locationX>
        <locationY>1467</locationY>
        <assignmentItems>
            <assignToReference>recCase.OwnerId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$User.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Case</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Change_ownership_0</name>
        <label>Change ownership</label>
        <locationX>1054</locationX>
        <locationY>1470</locationY>
        <assignmentItems>
            <assignToReference>recCase.OwnerId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$User.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Case_0</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Change_status</name>
        <label>Change status</label>
        <locationX>827</locationX>
        <locationY>1467</locationY>
        <assignmentItems>
            <assignToReference>recCase.Status</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>In Progress</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Change_ownership</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Change_status_0</name>
        <label>Change status</label>
        <locationX>915</locationX>
        <locationY>1609</locationY>
        <assignmentItems>
            <assignToReference>recCase.Status</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>In Progress</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Case</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_current_owner</name>
        <label>Set current owner</label>
        <locationX>900</locationX>
        <locationY>689</locationY>
        <assignmentItems>
            <assignToReference>varIAmNotTheOwner</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Assign_Case_record_details</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Current_case_owner</name>
        <label>Current case owner</label>
        <locationX>931</locationX>
        <locationY>1372</locationY>
        <defaultConnector>
            <targetReference>Change_status</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Me</defaultConnectorLabel>
        <rules>
            <name>Someone_else</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varIAmNotTheOwner</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Change_ownership_0</targetReference>
            </connector>
            <label>Someone else</label>
        </rules>
    </decisions>
    <decisions>
        <name>Is_Case_owned_by_a_Queue_or_a_User</name>
        <label>Is Case owned by a Queue or a User?</label>
        <locationX>770</locationX>
        <locationY>619</locationY>
        <defaultConnector>
            <targetReference>Owned_by_the_running_user</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>User</defaultConnectorLabel>
        <rules>
            <name>Queue</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Case.OwnerId</leftValueReference>
                <operator>StartsWith</operator>
                <rightValue>
                    <stringValue>00G</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Case_record_details</targetReference>
            </connector>
            <label>Queue</label>
        </rules>
    </decisions>
    <decisions>
        <name>Owned_by_the_running_user</name>
        <label>Owned by the running user</label>
        <locationX>1126</locationX>
        <locationY>622</locationY>
        <defaultConnector>
            <targetReference>Owner_is_another_user</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Case.OwnerId</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>fxRunningUserId</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Owner_is_the_running_user</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Running_user_is_IM</name>
        <label>Running user is IM?</label>
        <locationX>658</locationX>
        <locationY>324</locationY>
        <defaultConnector>
            <targetReference>User_is_not_Installation_Manager</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes2</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Profile.Id</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>fxProfileId</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Case</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <description>If Case Status is New, then the status can be changed.
If Status is In Progress, then only ownership can be changed.
If Status is something else, then abort.</description>
        <name>What_is_the_Case_Status</name>
        <label>What is the Case Status?</label>
        <locationX>778</locationX>
        <locationY>1012</locationY>
        <defaultConnector>
            <targetReference>Change_Ownership_2</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Something else</defaultConnectorLabel>
        <rules>
            <name>New</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Case.Status</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>New</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Change_ownership_and_status</targetReference>
            </connector>
            <label>New</label>
        </rules>
        <rules>
            <name>In_Progress</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Case.Status</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>In Progress</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Change_ownership_only</targetReference>
            </connector>
            <label>In Progress</label>
        </rules>
        <rules>
            <name>Closed_or_Resolved</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>Case.Status</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Closed</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Case.Status</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Resolved</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Ignore</targetReference>
            </connector>
            <label>Closed or Resolved</label>
        </rules>
    </decisions>
    <description>Screen flow to take ownership of the Case.

3.11.2023: Added check that running user is IM.
1.11.2023: First version.
02.12.2023: Save Active Version as R2</description>
    <environments>Default</environments>
    <formulas>
        <name>fxProfileId</name>
        <dataType>String</dataType>
        <expression>CASESAFEID({!$Profile.Id})</expression>
    </formulas>
    <formulas>
        <name>fxRunningUserId</name>
        <dataType>String</dataType>
        <expression>CASESAFEID({!$User.Id})</expression>
    </formulas>
    <interviewLabel>Case - Take Ownership {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Case - Take Ownership R2</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>Flow</processType>
    <recordLookups>
        <name>Case</name>
        <label>Case</label>
        <locationX>778</locationX>
        <locationY>483</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Is_Case_owned_by_a_Queue_or_a_User</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>recordId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Case</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Profile</name>
        <label>Profile</label>
        <locationX>666</locationX>
        <locationY>188</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Running_user_is_IM</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Name</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Lumon Installation Manager</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Profile</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_Case</name>
        <label>Update Case</label>
        <locationX>666</locationX>
        <locationY>1609</locationY>
        <inputReference>recCase</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Case_0</name>
        <label>Update Case</label>
        <locationX>1054</locationX>
        <locationY>1609</locationY>
        <connector>
            <targetReference>Change_status_0</targetReference>
        </connector>
        <inputReference>recCase</inputReference>
    </recordUpdates>
    <screens>
        <name>Change_Ownership_2</name>
        <label>Change Ownership 2</label>
        <locationX>658</locationX>
        <locationY>1241</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>Change_ownership</targetReference>
        </connector>
        <fields>
            <name>screenText_2</name>
            <fieldText>&lt;p&gt;Case status is {!Case.Status}. Are you sure that you want to take the Case ownership?&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <nextOrFinishButtonLabel>Take Ownership</nextOrFinishButtonLabel>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Change_ownership_and_status</name>
        <label>Change ownership and status</label>
        <locationX>936</locationX>
        <locationY>1232</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>Current_case_owner</targetReference>
        </connector>
        <fields>
            <name>screenText</name>
            <fieldText>&lt;p&gt;Do you want to take the ownership of the Case and change the Case Status to In Progress?&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <nextOrFinishButtonLabel>Take Ownership</nextOrFinishButtonLabel>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Change_ownership_only</name>
        <label>Change ownership only</label>
        <locationX>786</locationX>
        <locationY>1229</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>Change_ownership</targetReference>
        </connector>
        <fields>
            <name>screenText_1</name>
            <fieldText>&lt;p&gt;Do you want to take the ownership of the Case and keep the Case Status as In Progress?&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <nextOrFinishButtonLabel>Take Ownership</nextOrFinishButtonLabel>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Ignore</name>
        <label>Ignore</label>
        <locationX>530</locationX>
        <locationY>1240</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <fields>
            <name>screenText_2_0</name>
            <fieldText>&lt;p&gt;Case status is already &lt;span style=&quot;color: rgb(68, 68, 68); background-color: rgb(255, 255, 255);&quot;&gt;Closed/Resolved&lt;/span&gt;. Changes will not be done.&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <nextOrFinishButtonLabel>Do nothing</nextOrFinishButtonLabel>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Owner_is_another_user</name>
        <label>Owner is another user</label>
        <locationX>1006</locationX>
        <locationY>689</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>Set_current_owner</targetReference>
        </connector>
        <fields>
            <name>screentext1</name>
            <fieldText>&lt;p&gt;Case is already owned by {!Case.Owner:User.FirstName} {!Case.Owner:User.LastName}. Do you still want to continue?&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <nextOrFinishButtonLabel>Yes</nextOrFinishButtonLabel>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Owner_is_the_running_user</name>
        <label>Owner is the running user</label>
        <locationX>1134</locationX>
        <locationY>849</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>Assign_Case_record_details</targetReference>
        </connector>
        <fields>
            <name>screentext2</name>
            <fieldText>&lt;p&gt;Case is already owned by You. Do you still want to continue?&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <nextOrFinishButtonLabel>Yes</nextOrFinishButtonLabel>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>User_is_not_Installation_Manager</name>
        <label>User is not Installation Manager</label>
        <locationX>550</locationX>
        <locationY>483</locationY>
        <allowBack>false</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>Case</targetReference>
        </connector>
        <fields>
            <name>screentext3</name>
            <fieldText>&lt;p&gt;You are not an Installation Manager. Are you sure you want to proceed?&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <nextOrFinishButtonLabel>Yes</nextOrFinishButtonLabel>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <start>
        <locationX>540</locationX>
        <locationY>50</locationY>
        <connector>
            <targetReference>Profile</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <name>recCase</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Case</objectType>
    </variables>
    <variables>
        <name>recordId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>varIAmNotTheOwner</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
