<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>56.0</apiVersion>
    <assignments>
        <name>Add_ST_id_to_list</name>
        <label>Add ST id to list</label>
        <locationX>1269</locationX>
        <locationY>436</locationY>
        <assignmentItems>
            <assignToReference>collSTids</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>txtSTid</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>STMsLoop</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_to_collection</name>
        <label>Add to collection</label>
        <locationX>1098</locationX>
        <locationY>1210</locationY>
        <assignmentItems>
            <assignToReference>collShiftShare</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>recShiftShare</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Sharing_record</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Clear_var</name>
        <label>Clear var</label>
        <locationX>1366</locationX>
        <locationY>683</locationY>
        <assignmentItems>
            <assignToReference>txtUserId</assignToReference>
            <operator>Assign</operator>
        </assignmentItems>
        <connector>
            <targetReference>To_User_Id</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Clear_var_0</name>
        <label>Clear var</label>
        <locationX>1163</locationX>
        <locationY>317</locationY>
        <assignmentItems>
            <assignToReference>txtSTid</assignToReference>
            <operator>Assign</operator>
        </assignmentItems>
        <connector>
            <targetReference>STid</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Count_of_IMs</name>
        <label>Count of IMs</label>
        <locationX>838</locationX>
        <locationY>867</locationY>
        <assignmentItems>
            <assignToReference>nbrIMs</assignToReference>
            <operator>AssignCount</operator>
            <value>
                <elementReference>IMs</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>IM_s_exists</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_one_record</name>
        <label>Set one record</label>
        <locationX>1098</locationX>
        <locationY>1082</locationY>
        <assignmentItems>
            <assignToReference>recShiftShare.AccessLevel</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Edit</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>recShiftShare.ParentId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>recShiftShare.RowCause</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Manual</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>recShiftShare.UserOrGroupId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Sharing_record.Id</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_to_collection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>STid</name>
        <label>ST Id</label>
        <locationX>1267</locationX>
        <locationY>317</locationY>
        <assignmentItems>
            <assignToReference>txtSTid</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>STMsLoop.ServiceTerritoryId</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_ST_id_to_list</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>To_User_Id</name>
        <label>To User Id</label>
        <locationX>1474</locationX>
        <locationY>683</locationY>
        <assignmentItems>
            <assignToReference>txtUserId</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Go_through_ST_Users.FSL__User__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>To_User_Ids</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>To_User_Ids</name>
        <label>To User Ids</label>
        <locationX>1475</locationX>
        <locationY>814</locationY>
        <assignmentItems>
            <assignToReference>collUserIdsInST</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>txtUserId</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Go_through_ST_Users</targetReference>
        </connector>
    </assignments>
    <collectionProcessors>
        <name>Debug_ShiftShare</name>
        <elementSubtype>SortCollectionProcessor</elementSubtype>
        <label>Debug ShiftShare</label>
        <locationX>724</locationX>
        <locationY>1083</locationY>
        <collectionProcessorType>SortCollectionProcessor</collectionProcessorType>
        <collectionReference>collShiftShare</collectionReference>
        <connector>
            <targetReference>Shift_Share</targetReference>
        </connector>
        <sortOptions>
            <doesPutEmptyStringAndNullFirst>false</doesPutEmptyStringAndNullFirst>
            <sortField>Id</sortField>
            <sortOrder>Asc</sortOrder>
        </sortOptions>
    </collectionProcessors>
    <collectionProcessors>
        <name>Debug_STM</name>
        <elementSubtype>SortCollectionProcessor</elementSubtype>
        <label>Debug STM</label>
        <locationX>886</locationX>
        <locationY>329</locationY>
        <collectionProcessorType>SortCollectionProcessor</collectionProcessorType>
        <collectionReference>STM</collectionReference>
        <connector>
            <targetReference>STMsLoop</targetReference>
        </connector>
        <sortOptions>
            <doesPutEmptyStringAndNullFirst>false</doesPutEmptyStringAndNullFirst>
            <sortField>ServiceTerritoryId</sortField>
            <sortOrder>Asc</sortOrder>
        </sortOptions>
    </collectionProcessors>
    <collectionProcessors>
        <name>Debug_STs</name>
        <elementSubtype>SortCollectionProcessor</elementSubtype>
        <label>Debug STs</label>
        <locationX>989</locationX>
        <locationY>464</locationY>
        <collectionProcessorType>SortCollectionProcessor</collectionProcessorType>
        <collectionReference>collSTids</collectionReference>
        <connector>
            <targetReference>IM_profile_id</targetReference>
        </connector>
        <sortOptions>
            <doesPutEmptyStringAndNullFirst>false</doesPutEmptyStringAndNullFirst>
            <sortOrder>Asc</sortOrder>
        </sortOptions>
    </collectionProcessors>
    <collectionProcessors>
        <name>Debug_Users</name>
        <elementSubtype>SortCollectionProcessor</elementSubtype>
        <label>Debug Users</label>
        <locationX>948</locationX>
        <locationY>867</locationY>
        <collectionProcessorType>SortCollectionProcessor</collectionProcessorType>
        <collectionReference>IMs</collectionReference>
        <connector>
            <targetReference>Count_of_IMs</targetReference>
        </connector>
        <sortOptions>
            <doesPutEmptyStringAndNullFirst>false</doesPutEmptyStringAndNullFirst>
            <sortField>Id</sortField>
            <sortOrder>Asc</sortOrder>
        </sortOptions>
    </collectionProcessors>
    <collectionProcessors>
        <name>Debug_UT_Users</name>
        <elementSubtype>SortCollectionProcessor</elementSubtype>
        <label>Debug UT Users</label>
        <locationX>1076</locationX>
        <locationY>683</locationY>
        <collectionProcessorType>SortCollectionProcessor</collectionProcessorType>
        <collectionReference>User_Territories</collectionReference>
        <connector>
            <targetReference>Go_through_ST_Users</targetReference>
        </connector>
        <sortOptions>
            <doesPutEmptyStringAndNullFirst>false</doesPutEmptyStringAndNullFirst>
            <sortField>FSL__User__c</sortField>
            <sortOrder>Asc</sortOrder>
        </sortOptions>
    </collectionProcessors>
    <collectionProcessors>
        <name>Dummy_Sort</name>
        <elementSubtype>SortCollectionProcessor</elementSubtype>
        <label>Dummy Sort</label>
        <locationX>1194</locationX>
        <locationY>867</locationY>
        <collectionProcessorType>SortCollectionProcessor</collectionProcessorType>
        <collectionReference>User_Territories</collectionReference>
        <connector>
            <targetReference>IMs</targetReference>
        </connector>
        <sortOptions>
            <doesPutEmptyStringAndNullFirst>false</doesPutEmptyStringAndNullFirst>
            <sortField>FSL__User__c</sortField>
            <sortOrder>Asc</sortOrder>
        </sortOptions>
    </collectionProcessors>
    <decisions>
        <name>IM_profile_exists</name>
        <label>IM profile exists</label>
        <locationX>853</locationX>
        <locationY>589</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes2</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>IM_profile_id.Id</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>User_Territories</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>IM_s_exists</name>
        <label>IM(s) exists</label>
        <locationX>830</locationX>
        <locationY>999</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Yes4</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>nbrIMs</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Sharing_record</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <description>Shares the Shift with all Installation Managers located in the same User Territory.
02.12.2023: Save Active Version as R2

30.1.2023: First version.</description>
    <environments>Default</environments>
    <interviewLabel>Shift - Share with other IMs in same UT {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Shift - Share with other IMs in same UT R2</label>
    <loops>
        <name>Go_through_ST_Users</name>
        <label>Go through ST Users</label>
        <locationX>1194</locationX>
        <locationY>683</locationY>
        <collectionReference>User_Territories</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Clear_var</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Dummy_Sort</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Sharing_record</name>
        <label>Sharing record</label>
        <locationX>928</locationX>
        <locationY>1081</locationY>
        <collectionReference>IMs</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Set_one_record</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Debug_ShiftShare</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>STMsLoop</name>
        <label>STMs</label>
        <locationX>989</locationX>
        <locationY>329</locationY>
        <collectionReference>STM</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Clear_var_0</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Debug_STs</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <description>Create manual sharing record for all the filtered Installation Managers so that they can access the Shift data.</description>
        <name>Shift_Share</name>
        <label>Shift Share</label>
        <locationX>600</locationX>
        <locationY>1083</locationY>
        <inputReference>collShiftShare</inputReference>
    </recordCreates>
    <recordLookups>
        <name>IM_profile_id</name>
        <label>IM profile id</label>
        <locationX>861</locationX>
        <locationY>464</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>IM_profile_exists</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Name</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Lumon Installation Manager</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Profile</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Filter in from the User Territory users only those who are active Installation Managers.</description>
        <name>IMs</name>
        <label>IMs</label>
        <locationX>1071</locationX>
        <locationY>867</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Debug_Users</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>In</operator>
            <value>
                <elementReference>collUserIdsInST</elementReference>
            </value>
        </filters>
        <filters>
            <field>ProfileId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>IM_profile_id.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>IsActive</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>User</object>
        <queriedFields>Id</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Service_Resource</name>
        <label>Service Resource</label>
        <locationX>658</locationX>
        <locationY>329</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>STM</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.ServiceResourceId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ServiceResource</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Find out all Service Territory Memberships the Shift related Service Resource has. i.e. in which Service Territories he works on.</description>
        <name>STM</name>
        <label>STM</label>
        <locationX>778</locationX>
        <locationY>329</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Debug_STM</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>ServiceResourceId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Service_Resource.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>ServiceTerritoryMember</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Find out all User Territory users (Installation Managers and Sales Persons) in the related Service Territories.</description>
        <name>User_Territories</name>
        <label>User Territories</label>
        <locationX>954</locationX>
        <locationY>683</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Debug_UT_Users</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>FSL__ServiceTerritory__c</field>
            <operator>In</operator>
            <value>
                <elementReference>collSTids</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>FSL__User_Territory__c</object>
        <queriedFields>Id</queriedFields>
        <queriedFields>FSL__User__c</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <start>
        <locationX>532</locationX>
        <locationY>50</locationY>
        <connector>
            <targetReference>Service_Resource</targetReference>
        </connector>
        <object>Shift</object>
        <recordTriggerType>Create</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>collShiftShare</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ShiftShare</objectType>
    </variables>
    <variables>
        <name>collSTids</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>collUserIdsInST</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>nbrIMs</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
    </variables>
    <variables>
        <name>recShiftShare</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ShiftShare</objectType>
    </variables>
    <variables>
        <name>txtSTid</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>txtUserId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
