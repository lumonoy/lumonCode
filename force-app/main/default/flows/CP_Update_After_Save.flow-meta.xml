<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>56.0</apiVersion>
    <assignments>
        <name>Add_CDD_to_SA</name>
        <label>Add CDD to SA</label>
        <locationX>1892</locationX>
        <locationY>1135</locationY>
        <assignmentItems>
            <assignToReference>recUpdatedSA.Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Updated_SAs.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>recUpdatedSA.Confirmed_Delivery_Date__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.Confirmed_Delivery_Date__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>recUpdatedSA.FSL__GanttIcon__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>fxGANTTicon</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_to_collection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_to_collection</name>
        <label>Add to collection</label>
        <locationX>2106</locationX>
        <locationY>986</locationY>
        <assignmentItems>
            <assignToReference>collUpdatedSAs</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>recUpdatedSA</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Updated_SAs</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_WO</name>
        <label>Add WO</label>
        <locationX>1482</locationX>
        <locationY>1006</locationY>
        <assignmentItems>
            <assignToReference>txtWOid</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>WOLIs.WorkOrderId</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Related_WOs</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Number_of_SAs</name>
        <label>Number of SAs</label>
        <locationX>1750</locationX>
        <locationY>1101</locationY>
        <assignmentItems>
            <assignToReference>nbrUpdatedSAs</assignToReference>
            <operator>AssignCount</operator>
            <value>
                <elementReference>collUpdatedSAs</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Any_updated_SAs</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Number_of_WOLIs</name>
        <label>Number of WOLIs</label>
        <locationX>1257</locationX>
        <locationY>628</locationY>
        <assignmentItems>
            <assignToReference>nbrWOLIs</assignToReference>
            <operator>AssignCount</operator>
            <value>
                <elementReference>WOLI</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Any_WOLIs</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Related_WOs</name>
        <label>Related WOs</label>
        <locationX>1355</locationX>
        <locationY>1006</locationY>
        <assignmentItems>
            <assignToReference>collWOs</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>txtWOid</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>WOLIs</targetReference>
        </connector>
    </assignments>
    <collectionProcessors>
        <name>Sort_SAs</name>
        <elementSubtype>SortCollectionProcessor</elementSubtype>
        <label>Sort SAs</label>
        <locationX>1891</locationX>
        <locationY>844</locationY>
        <collectionProcessorType>SortCollectionProcessor</collectionProcessorType>
        <collectionReference>SAs</collectionReference>
        <connector>
            <targetReference>Updated_SAs</targetReference>
        </connector>
        <sortOptions>
            <doesPutEmptyStringAndNullFirst>false</doesPutEmptyStringAndNullFirst>
            <sortField>CreatedDate</sortField>
            <sortOrder>Asc</sortOrder>
        </sortOptions>
    </collectionProcessors>
    <collectionProcessors>
        <name>Sort_WOs</name>
        <elementSubtype>SortCollectionProcessor</elementSubtype>
        <label>Sort WOs</label>
        <locationX>1663</locationX>
        <locationY>844</locationY>
        <collectionProcessorType>SortCollectionProcessor</collectionProcessorType>
        <collectionReference>WOs</collectionReference>
        <connector>
            <targetReference>SAs</targetReference>
        </connector>
        <sortOptions>
            <doesPutEmptyStringAndNullFirst>false</doesPutEmptyStringAndNullFirst>
            <sortField>Id</sortField>
            <sortOrder>Asc</sortOrder>
        </sortOptions>
    </collectionProcessors>
    <decisions>
        <name>Any_updated_SAs</name>
        <label>Any updated SAs</label>
        <locationX>1742</locationX>
        <locationY>1243</locationY>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes2_0</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>nbrUpdatedSAs</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_all_SAs</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Any_WOLIs</name>
        <label>Any WOLIs?</label>
        <locationX>1249</locationX>
        <locationY>754</locationY>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes2</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>nbrWOLIs</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>WOLIs</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Related_Oppo_exists</name>
        <label>Related Oppo exists?</label>
        <locationX>902</locationX>
        <locationY>522</locationY>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Opportunity__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Opportunity</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <description>Actions done when Configuration Product gets updated. Confirmed Delivery Date change triggers an action.

27.10.2023: Change CDD logic so that Oppo no longer contains (need to be updated) the CDD. CP and SA has it.
14.8.2023: Fix for the icon color logic.
24.5.2022: Fix in the CDD comparison logic.
22.5.2022: CDD updates also to GANTT label.
19.5.2023: Update Service Appointment with CDD.
3.2.2023: First version
02.12.2023: Save Active Version as R2</description>
    <environments>Default</environments>
    <formulas>
        <name>fxGANTTicon</name>
        <dataType>String</dataType>
        <expression>/* Selects proper icon to be used in SA.Gantt_icon__c field based on timing of the Confirmed Delivery Date change */
IF
(
   {!$Record.Confirmed_Delivery_Date__c} &lt; DATEVALUE({!Updated_SAs.SchedStartTime}), 
   &quot;/img/msg_icons/confirm24.png&quot;, 
   IF
   (
       {!$Record.Confirmed_Delivery_Date__c} = DATEVALUE({!Updated_SAs.SchedStartTime}),
       &quot;/img/msg_icons/warning24.png&quot;,
       IF
       (
          {!$Record.Confirmed_Delivery_Date__c} &gt; DATEVALUE({!Updated_SAs.SchedStartTime}),
          &quot;/img/msg_icons/error24.png&quot;,
          {!Updated_SAs.FSL__GanttIcon__c}
       )
  )
)</expression>
    </formulas>
    <interviewLabel>CP - Update After Save {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Configuration Product - Update After Save R2</label>
    <loops>
        <name>Updated_SAs</name>
        <label>Updated SAs</label>
        <locationX>1891</locationX>
        <locationY>978</locationY>
        <collectionReference>SAs</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Add_CDD_to_SA</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Number_of_SAs</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>WOLIs</name>
        <label>WOLIs</label>
        <locationX>1363</locationX>
        <locationY>844</locationY>
        <collectionReference>WOLI</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Add_WO</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>WOs</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <description>Get CDD from Oppo.</description>
        <name>Opportunity</name>
        <label>Opportunity</label>
        <locationX>988</locationX>
        <locationY>628</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>WOLI</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Opportunity__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Opportunity</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Gets the SAs that are active i.e. not completed and not canceled that belong under the WOs in the collWOs collection.</description>
        <name>SAs</name>
        <label>SAs</label>
        <locationX>1773</locationX>
        <locationY>844</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Sort_SAs</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>LUM_Parent_Work_Order__c</field>
            <operator>In</operator>
            <value>
                <elementReference>collWOs</elementReference>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>Completed</stringValue>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>Canceled</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>ServiceAppointment</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>This starts the logic to find out related Service Appointments and update the CDD to each of them.</description>
        <name>WOLI</name>
        <label>WOLI</label>
        <locationX>1126</locationX>
        <locationY>628</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Number_of_WOLIs</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Configuration_Product__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>WorkOrderLineItem</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>WOs</name>
        <label>WOs</label>
        <locationX>1548</locationX>
        <locationY>844</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Sort_WOs</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>In</operator>
            <value>
                <elementReference>collWOs</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>WorkOrder</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_all_SAs</name>
        <label>Update all SAs</label>
        <locationX>1848</locationX>
        <locationY>1395</locationY>
        <connector>
            <targetReference>Notify_max_5_IMs_of_the_Service_Territory</targetReference>
        </connector>
        <inputReference>collUpdatedSAs</inputReference>
    </recordUpdates>
    <start>
        <locationX>784</locationX>
        <locationY>209</locationY>
        <connector>
            <targetReference>Related_Oppo_exists</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Confirmed_Delivery_Date__c</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>Configuration_Product__c</object>
        <recordTriggerType>Update</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <subflows>
        <description>Finds from Oppo related WO max 5 IMs on the Service Territory and notifies them of the CDD change via email.</description>
        <name>Notify_max_5_IMs_of_the_Service_Territory</name>
        <label>Notify max 5 IMs of the Service Territory</label>
        <locationX>1986</locationX>
        <locationY>1395</locationY>
        <flowName>Opportunity_Confirmed_Delivery_Date_check_subflow</flowName>
        <inputAssignments>
            <name>OppoId</name>
            <value>
                <elementReference>$Record.Opportunity__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>varConfigurationProductId</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>varNewCDD</name>
            <value>
                <elementReference>$Record.Confirmed_Delivery_Date__c</elementReference>
            </value>
        </inputAssignments>
    </subflows>
    <variables>
        <name>collUpdatedSAs</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ServiceAppointment</objectType>
    </variables>
    <variables>
        <name>collWOs</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>nbrUpdatedSAs</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
    </variables>
    <variables>
        <name>nbrWOLIs</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
    </variables>
    <variables>
        <name>recUpdatedSA</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>ServiceAppointment</objectType>
    </variables>
    <variables>
        <name>recWO</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>WorkOrder</objectType>
    </variables>
    <variables>
        <name>txtCDDstatus</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>txtWOid</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
